// Generated by gcp2gc
const { GoogleProvider } = require("@grucloud/provider-google");

const createResources = ({ provider }) => {
  provider.compute.makeFirewall({
    name: "default-allow-icmp",
    properties: ({ config }) => ({
      description: "Allow ICMP from anywhere",
      priority: 65534,
      sourceRanges: ["0.0.0.0/0"],
      allowed: [
        {
          IPProtocol: "icmp",
        },
      ],
      direction: "INGRESS",
      logConfig: {
        enable: false,
      },
    }),
  });

  provider.compute.makeFirewall({
    name: "default-allow-internal",
    properties: ({ config }) => ({
      description: "Allow internal traffic on the default network",
      priority: 65534,
      sourceRanges: ["10.128.0.0/9"],
      allowed: [
        {
          IPProtocol: "tcp",
          ports: ["0-65535"],
        },
        {
          IPProtocol: "udp",
          ports: ["0-65535"],
        },
        {
          IPProtocol: "icmp",
        },
      ],
      direction: "INGRESS",
      logConfig: {
        enable: false,
      },
    }),
  });

  provider.compute.makeFirewall({
    name: "default-allow-rdp",
    properties: ({ config }) => ({
      description: "Allow RDP from anywhere",
      priority: 65534,
      sourceRanges: ["0.0.0.0/0"],
      allowed: [
        {
          IPProtocol: "tcp",
          ports: ["3389"],
        },
      ],
      direction: "INGRESS",
      logConfig: {
        enable: false,
      },
    }),
  });

  provider.compute.makeFirewall({
    name: "default-allow-ssh",
    properties: ({ config }) => ({
      description: "Allow SSH from anywhere",
      priority: 65534,
      sourceRanges: ["0.0.0.0/0"],
      allowed: [
        {
          IPProtocol: "tcp",
          ports: ["22"],
        },
      ],
      direction: "INGRESS",
      logConfig: {
        enable: false,
      },
    }),
  });

  provider.compute.makeVmInstance({
    name: "web-server",
    properties: ({ config }) => ({
      tags: {},
      machineType: "f1-micro",
      canIpForward: false,
      metadata: {
        items: [
          {
            key: "enable-oslogin",
            value: "True",
          },
        ],
      },
      labels: {
        "managed-by": "grucloud",
        "gc-stage": "dev",
      },
      startRestricted: false,
      deletionProtection: false,
      reservationAffinity: {
        consumeReservationType: "ANY_RESERVATION",
      },
      displayDevice: {
        enableDisplay: false,
      },
      shieldedInstanceConfig: {
        enableSecureBoot: false,
        enableVtpm: true,
        enableIntegrityMonitoring: true,
      },
      shieldedInstanceIntegrityPolicy: {
        updateAutoLearnPolicy: true,
      },
      confidentialInstanceConfig: {
        enableConfidentialCompute: false,
      },
      sourceImage:
        "projects/ubuntu-os-cloud/global/images/ubuntu-2004-focal-v20210908",
    }),
  });
};

exports.createResources = createResources;

exports.createStack = async ({ createProvider }) => {
  const provider = createProvider(GoogleProvider, {
    config: require("./config"),
  });
  createResources({
    provider,
  });

  return {
    provider,
  };
};
